<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IsoGleam Viewer - Cap√£o Bonito Isom√©trico</title>
    <script src="https://cdn.jsdelivr.net/npm/openseadragon@4.1/build/openseadragon/openseadragon.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #1a1a2e;
            color: #eee;
        }
        #header {
            background: #16213e;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #0f3460;
        }
        #header h1 {
            font-size: 1.4em;
            color: #e94560;
        }
        #header .badge {
            background: #e94560;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
        }
        #viewer {
            width: 100%;
            height: calc(100vh - 120px);
            background: #0f0f23;
        }
        #controls {
            background: #16213e;
            padding: 10px 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            border-top: 2px solid #0f3460;
        }
        #controls label {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #controls input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #e94560;
        }
        #coords {
            margin-left: auto;
            font-family: monospace;
            color: #7f8c8d;
        }
        .layer-toggle {
            cursor: pointer;
            padding: 6px 14px;
            background: #0f3460;
            border: none;
            border-radius: 6px;
            color: #eee;
            transition: all 0.2s;
        }
        .layer-toggle:hover {
            background: #e94560;
        }
        .layer-toggle.active {
            background: #e94560;
        }
        #info-panel {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(22, 33, 62, 0.95);
            padding: 15px;
            border-radius: 8px;
            min-width: 200px;
            display: none;
        }
        #info-panel h3 {
            color: #e94560;
            margin-bottom: 10px;
        }
        #info-panel p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        #loading .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #0f3460;
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>üèôÔ∏è IsoGleam Viewer - Cap√£o Bonito</h1>
        <span class="badge">Pure Gleam ‚Ä¢ RTX 4090 ‚Ä¢ $0</span>
    </div>

    <div id="viewer">
        <div id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px;">Carregando tiles...</p>
        </div>
    </div>

    <div id="controls">
        <button class="layer-toggle active" data-layer="buildings">üè† Pr√©dios</button>
        <button class="layer-toggle active" data-layer="roads">üõ£Ô∏è Ruas</button>
        <button class="layer-toggle active" data-layer="vegetation">üå≥ Vegeta√ß√£o</button>
        <button class="layer-toggle" data-layer="water">üíß √Ågua</button>
        <label>
            <input type="checkbox" id="show-grid">
            Mostrar Grid
        </label>
        <span id="coords">X: 0 | Y: 0 | Zoom: 1.0x</span>
    </div>

    <div id="info-panel">
        <h3>Tile Info</h3>
        <p><strong>Coord:</strong> <span id="tile-coord">-</span></p>
        <p><strong>Tipo:</strong> <span id="tile-type">-</span></p>
        <p><strong>Score QA:</strong> <span id="tile-score">-</span></p>
        <p><strong>Gerado:</strong> <span id="tile-date">-</span></p>
    </div>

    <script>
        // IsoGleam Viewer - OpenSeaDragon integration
        const viewer = OpenSeadragon({
            id: 'viewer',
            prefixUrl: 'https://cdn.jsdelivr.net/npm/openseadragon@4.1/build/openseadragon/images/',
            tileSources: 'tiles/capao_bonito.dzi',
            showNavigator: true,
            navigatorPosition: 'BOTTOM_LEFT',
            minZoomLevel: 0.3,
            maxZoomLevel: 20,
            visibilityRatio: 0.5,
            constrainDuringPan: true,
            animationTime: 0.3,
            zoomPerScroll: 1.3,
            defaultZoomLevel: 1,
        });

        // Hide loading when ready
        viewer.addHandler('open', () => {
            document.getElementById('loading').style.display = 'none';
        });

        // Update coordinates on mouse move
        viewer.addHandler('canvas-scroll', updateCoords);
        viewer.addHandler('canvas-drag', updateCoords);

        function updateCoords() {
            const zoom = viewer.viewport.getZoom(true).toFixed(2);
            const center = viewer.viewport.getCenter(true);
            document.getElementById('coords').textContent =
                `X: ${center.x.toFixed(0)} | Y: ${center.y.toFixed(0)} | Zoom: ${zoom}x`;
        }

        // Layer toggle buttons
        document.querySelectorAll('.layer-toggle').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('active');
                const layer = btn.dataset.layer;
                console.log(`Toggle layer: ${layer}`);
                // TODO: Implement actual layer filtering
            });
        });

        // Show tile info on click
        viewer.addHandler('canvas-click', (event) => {
            const webPoint = event.position;
            const viewportPoint = viewer.viewport.pointFromPixel(webPoint);

            // Calculate tile coordinates (512px tiles)
            const tileX = Math.floor(viewportPoint.x * 512);
            const tileY = Math.floor(viewportPoint.y * 512);

            // Show info panel
            const panel = document.getElementById('info-panel');
            panel.style.display = 'block';
            document.getElementById('tile-coord').textContent = `${tileX}, ${tileY}`;
            document.getElementById('tile-type').textContent = 'Residencial';
            document.getElementById('tile-score').textContent = '98.5%';
            document.getElementById('tile-date').textContent = new Date().toLocaleDateString('pt-BR');
        });

        // Grid overlay toggle
        document.getElementById('show-grid').addEventListener('change', (e) => {
            console.log('Grid:', e.target.checked);
            // TODO: Implement grid overlay
        });

        // Grid config (from generation)
        const GRID_CONFIG = {
            tileSize: 480,  // 512 - 32 blend
            gridSize: 7,
            centerTile: { x: 26, y: 23 },
            minTile: { x: 23, y: 20 },
            imageSize: 3392
        };

        // Calculate tile from click position
        function getTileFromPoint(viewportPoint) {
            const pixelX = viewportPoint.x * GRID_CONFIG.imageSize;
            const pixelY = viewportPoint.y * GRID_CONFIG.imageSize;
            const tileX = GRID_CONFIG.minTile.x + Math.floor(pixelX / GRID_CONFIG.tileSize);
            const tileY = GRID_CONFIG.minTile.y + (GRID_CONFIG.gridSize - 1 - Math.floor(pixelY / GRID_CONFIG.tileSize));
            return { x: tileX, y: tileY };
        }

        // Update click handler with real tile info
        viewer.removeAllHandlers('canvas-click');
        viewer.addHandler('canvas-click', (event) => {
            const webPoint = event.position;
            const viewportPoint = viewer.viewport.pointFromPixel(webPoint);
            const tile = getTileFromPoint(viewportPoint);

            const panel = document.getElementById('info-panel');
            panel.style.display = 'block';
            document.getElementById('tile-coord').textContent = `tile_${tile.x.toString().padStart(2,'0')}_${tile.y.toString().padStart(2,'0')}`;
            document.getElementById('tile-type').textContent = 'Urban Center';
            document.getElementById('tile-score').textContent = '‚úì Gerado';
            document.getElementById('tile-date').textContent = new Date().toLocaleDateString('pt-BR');
        });

        console.log('IsoGleam Viewer carregado - 3392x3392 px, 49 tiles');
    </script>
</body>
</html>
