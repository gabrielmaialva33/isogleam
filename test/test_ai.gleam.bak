import gleam/int
import gleam/io
import gleam/option.{None}
import gleam/string
import isogleam/ffi/fs
import isogleam/ffi/nvidia

pub fn main() {
  io.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
  io.println("â•‘   ISOGLEAM AI INTEGRATION TEST        â•‘")
  io.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")

  let config = nvidia.default_config()

  // Test 1: Health Check
  io.println("ğŸ” Test 1: Health Check")
  case nvidia.health_check(config) {
    True -> io.println("âœ… AI Server is online!\n")
    False -> {
      io.println("âŒ AI Server is offline!")
      io.println("   Run: python scripts/ai_server.py\n")
    }
  }

  // Test 2: Generate Tile (simple prompt, no control image)
  io.println("ğŸ¨ Test 2: Generate Tile (Text-to-Image)")
  io.println("   Prompt: brick building with red roof")
  io.println("   This will take ~2-3s on RTX 4090...\n")

  case nvidia.generate_tile("brick building with red roof", None, 42, config) {
    Ok(image_b64) -> {
      io.println("âœ… Image generated successfully!")
      io.println("   Base64 check: " <> string.slice(image_b64, 0, 20) <> "...")

      // Save for humiliation proof
      // Save for humiliation proof
      case fs.write_base64_image("humiliation_proof.png", image_b64) {
        Ok(_) -> io.println("ğŸ’¾ Saved to humiliation_proof.png")
        Error(_) -> io.println("âŒ Failed to save base64 image")
      }
    }
    Error(err) -> {
      io.println("âŒ Generation failed:")
      io.println("   Error: " <> err <> "\n")
    }
  }

  // Test 3: CLIP Embedding
  io.println("ğŸ§  Test 3: CLIP Embedding")
  case nvidia.clip_embed("fake_base64_for_testing", config) {
    Ok(embedding) -> {
      io.println("âœ… CLIP embedding obtained!")
      io.println(
        "   Vector dimensions: " <> int.to_string(embedding.dimensions) <> "\n",
      )
    }
    Error(err) -> {
      io.println("âš ï¸  Expected error (JSON parsing not implemented):")
      io.println("   " <> err <> "\n")
    }
  }

  // Test 4: CLIP Classification
  io.println("ğŸ·ï¸  Test 4: CLIP Classification")
  case
    nvidia.clip_classify("fake_base64", ["building", "tree", "water"], config)
  {
    Ok(classes) -> {
      io.println("âœ… Classification successful (placeholder)!")
      let first = case classes {
        [c, ..] -> c.label <> " (" <> string.inspect(c.confidence) <> ")"
        [] -> "no results"
      }
      io.println("   First result: " <> first <> "\n")
    }
    Error(err) -> {
      io.println("âš ï¸  Error:")
      io.println("   " <> err <> "\n")
    }
  }

  io.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
  io.println("â•‘   TEST SUITE COMPLETE                  â•‘")
  io.println("â•‘                                        â•‘")
  io.println("â•‘   NOTE: JSON parsing not yet           â•‘")
  io.println("â•‘   implemented, so most tests will      â•‘")
  io.println("â•‘   show expected errors.                â•‘")
  io.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
}
